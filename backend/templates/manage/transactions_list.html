{% extends 'base.html' %}
{% load static %}

{% block title %}Transacciones{% endblock %}

<style>
/* ===== NEO-BRUTALIST TRANSACTIONS LIST ===== */

/* Transaction Card - Neo-Brutalist Style */
.tx-card {
  padding: 0.75rem;
  border: 3px solid #0f172a;
  background: #ffffff;
  border-radius: 6px;
  box-shadow: 4px 4px 0 rgba(15, 23, 42, 0.15);
  margin-bottom: 0;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
  position: relative;
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.tx-card:hover {
  transform: translateY(-2px);
  box-shadow: 6px 6px 0 rgba(15, 23, 42, 0.2);
}

.tx-card * {
  font-family: inherit;
}

/* Grid Layout - Desktop */
.tx-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 1rem;
}

/* Header: ID + Date + Description + Amount */
.tx-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 0.75rem;
  margin-bottom: 0.65rem;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid #f1f5f9;
}

.tx-info {
  flex: 1;
  min-width: 0;
}

.tx-meta {
  font-size: 0.75rem;
  color: #64748b;
  margin-bottom: 0.3rem;
  font-weight: 600;
  letter-spacing: 0.01em;
}

.tx-id {
  font-weight: 800;
  margin-right: 0.5rem;
  color: #0f172a;
}

.tx-desc {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-weight: 600;
  font-size: 0.9rem;
  color: #0f172a;
  line-height: 1.4;
}

.tx-amount {
  font-weight: 800;
  font-size: 1.1rem;
  white-space: nowrap;
  color: #0f172a;
  padding: 0.25rem 0.5rem;
  background: #f1f5f9;
  border-radius: 4px;
}

/* Fields: Category, Source, Project */
.tx-fields {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 0.5rem;
  margin-bottom: 0.65rem;
}

.tx-field {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.tx-field label {
  font-size: 0.65rem;
  font-weight: 700;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  white-space: nowrap;
}

.tx-field select {
  width: 100%;
  padding: 0.45rem 0.55rem;
  font-size: 0.8rem;
  border: 2px solid #cbd5e1;
  background: #ffffff;
  color: #0f172a;
  font-family: inherit;
  border-radius: 4px;
  font-weight: 600;
  line-height: 1.3;
  transition: all 0.15s ease;
  cursor: pointer;
}

.tx-field select:hover {
  border-color: #94a3b8;
}

.tx-field select:focus {
  outline: none;
  border-color: #ff0066;
  box-shadow: 0 0 0 3px rgba(255, 0, 102, 0.1);
}

/* Footer: Comment + Delete */
.tx-footer {
  display: flex;
  gap: 0.5rem;
  align-items: stretch;
  padding-top: 0.5rem;
  border-top: 2px solid #f1f5f9;
}

.tx-comment {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.tx-comment label {
  font-size: 0.65rem;
  font-weight: 700;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.tx-comment textarea {
  width: 100%;
  padding: 0.45rem 0.55rem;
  font-size: 0.75rem;
  border: 2px solid #cbd5e1;
  background: #ffffff;
  color: #0f172a;
  font-family: inherit;
  resize: none;
  border-radius: 4px;
  min-height: 2.5rem;
  line-height: 1.4;
  transition: all 0.15s ease;
  font-weight: 500;
}

.tx-comment textarea:hover {
  border-color: #94a3b8;
}

.tx-comment textarea:focus {
  outline: none;
  border-color: #ff0066;
  box-shadow: 0 0 0 3px rgba(255, 0, 102, 0.1);
}

/* Save Status Indicator */
.save-status {
  font-size: 0.65rem;
  position: absolute;
  top: 0.75rem;
  right: 0.75rem;
  padding: 0.3rem 0.5rem;
  border-radius: 4px;
  background: #ffffff;
  font-weight: 700;
  z-index: 10;
}

/* Delete Button */
.delete-btn {
  align-self: flex-end;
  padding: 0.45rem 0.65rem !important;
  font-size: 1.1rem !important;
  line-height: 1 !important;
  white-space: nowrap;
  background: #dc2626 !important;
  color: white !important;
  border: 2px solid #b91c1c !important;
  border-radius: 4px !important;
  min-width: 44px;
  height: 2.5rem;
  transition: all 0.15s ease !important;
  box-shadow: 2px 2px 0 rgba(220, 38, 38, 0.3) !important;
  cursor: pointer;
  font-weight: 700;
}

.delete-btn:hover {
  transform: translateY(-1px);
  box-shadow: 3px 3px 0 rgba(220, 38, 38, 0.4) !important;
  background: #b91c1c !important;
}

/* Filters Section */
.filters-section {
  margin: 1rem 0;
  padding: 0.75rem;
  border: 3px solid var(--accent);
  background: var(--panel);
  border-radius: 4px;
  box-shadow: 6px 6px 0 rgba(15, 23, 42, 0.1);
}

#toggle-filters {
  background: var(--accent);
  color: white;
  padding: 0.5rem 1rem;
  font-size: 0.9rem;
  border: none;
  border-radius: 3px;
  font-weight: 700;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  box-shadow: 3px 3px 0 rgba(255, 0, 102, 0.2);
}

#toggle-filters:hover {
  transform: translateY(-1px);
  box-shadow: 4px 4px 0 rgba(255, 0, 102, 0.3);
}

/* Pagination */
.pagination a {
  color: var(--accent);
  font-weight: 700;
  text-decoration: none;
  transition: transform 0.2s ease;
  display: inline-block;
}

.pagination a:hover {
  transform: translateY(-1px);
}

/* ===== TABLET (641px - 959px) ===== */
@media (min-width: 641px) and (max-width: 959px) {
  .tx-list {
    grid-template-columns: repeat(2, 1fr);
    gap: 0.85rem;
  }

  .tx-card {
    padding: 0.6rem 0.7rem;
  }

  .tx-meta {
    font-size: 0.8rem;
  }

  .tx-desc {
    font-size: 0.9rem;
  }

  .tx-amount {
    font-size: 0.95rem;
  }

  .tx-field label {
    font-size: 0.7rem;
  }

  .tx-field select {
    font-size: 0.8rem;
    padding: 0.35rem 0.45rem;
  }

  .tx-comment textarea {
    font-size: 0.75rem;
    padding: 0.35rem 0.45rem;
  }
}

/* ===== MOBILE (‚â§640px) - COMPACT ===== */
@media (max-width: 640px) {
  .tx-list {
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }

  .tx-card {
    padding: 0.5rem;
    border-width: 2px;
    box-shadow: 3px 3px 0 rgba(15, 23, 42, 0.1);
  }

  .tx-card:hover {
    transform: none;
    box-shadow: 3px 3px 0 rgba(15, 23, 42, 0.1);
  }

  .tx-header {
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    padding-bottom: 0.4rem;
  }

  .tx-meta {
    font-size: 0.65rem;
    margin-bottom: 0.25rem;
  }

  .tx-id {
    margin-right: 0.35rem;
  }

  .tx-desc {
    font-size: 0.75rem;
  }

  .tx-amount {
    font-size: 0.85rem;
    padding: 0.2rem 0.4rem;
    font-size: 0.8rem;
  }

  /* Stack fields vertically on mobile */
  .tx-fields {
    grid-template-columns: 1fr;
    gap: 0.4rem;
    margin-bottom: 0.5rem;
  }

  .tx-field {
    gap: 0.2rem;
  }

  .tx-field label {
    font-size: 0.6rem;
  }

  .tx-field select {
    padding: 0.35rem 0.45rem;
    font-size: 0.7rem;
    min-height: auto;
  }

  .tx-footer {
    flex-direction: column;
    gap: 0.4rem;
    padding-top: 0.4rem;
  }

  .tx-comment {
    gap: 0.2rem;
  }

  .tx-comment label {
    font-size: 0.6rem;
  }

  .tx-comment textarea {
    padding: 0.35rem 0.45rem;
    font-size: 0.7rem;
    min-height: 2rem;
  }

  .delete-btn {
    width: 100%;
    height: auto !important;
    padding: 0.4rem !important;
    font-size: 1rem !important;
    box-shadow: 2px 2px 0 rgba(220, 38, 38, 0.25) !important;
  }

  .delete-btn:hover {
    transform: none;
    box-shadow: 2px 2px 0 rgba(220, 38, 38, 0.25) !important;
  }

  .save-status {
    font-size: 0.6rem;
    top: 0.5rem;
    right: 0.5rem;
    padding: 0.25rem 0.4rem;
  }

  /* Filters on mobile */
  .filters-section {
    border-width: 2px;
    box-shadow: 4px 4px 0 rgba(15, 23, 42, 0.1);
  }

  #toggle-filters {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
    box-shadow: 2px 2px 0 rgba(255, 0, 102, 0.2);
  }

  #toggle-filters:hover {
    transform: none;
    box-shadow: 2px 2px 0 rgba(255, 0, 102, 0.2);
  }

  section form[method="get"] {
    grid-template-columns: 1fr !important;
  }

  section form[method="get"] button,
  section form[method="get"] a {
    width: 100%;
    text-align: center;
  }
}
</style>

{% block content %}
<p><a href="{% url 'profile' %}">‚Üê Volver al perfil</a></p>
<h1>Transacciones</h1>

<!-- Filters Section -->
<section class="filters-section">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;">
    <h2 style="margin:0">Filtros</h2>
    <button type="button" id="toggle-filters">
      <span id="toggle-text">Mostrar filtros</span>
    </button>
  </div>
  <form method="get" id="filters-form">
    <div style="display:none !important;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:0.75rem;" id="filters-grid">
    <div>
      <label style="display:block;font-weight:600;margin-bottom:0.25rem;">Buscar</label>
      <input type="text" name="search" value="{{ current_filters.search }}" placeholder="Descripci√≥n..." style="width:100%;padding:0.45rem 0.55rem;">
    </div>
    <div>
      <label style="display:block;font-weight:600;margin-bottom:0.25rem;">Categor√≠a</label>
      <select name="category" style="width:100%;padding:0.45rem 0.55rem;">
        <option value="">Todas</option>
        <option value="__null__" {% if current_filters.category == '__null__' %}selected{% endif %}>‚ùå Sin categor√≠a</option>
        {% for cat in categories %}
          <option value="{{ cat.name }}" {% if current_filters.category == cat.name %}selected{% endif %}>{{ cat.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label style="display:block;font-weight:600;margin-bottom:0.25rem;">Origen</label>
      <select name="source" style="width:100%;padding:0.45rem 0.55rem;">
        <option value="">Todos</option>
        <option value="__null__" {% if current_filters.source == '__null__' %}selected{% endif %}>‚ùå Sin origen</option>
        {% for src in sources %}
          <option value="{{ src.name }}" {% if current_filters.source == src.name %}selected{% endif %}>{{ src.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label style="display:block;font-weight:600;margin-bottom:0.25rem;">Proyecto</label>
      <select name="project" style="width:100%;padding:0.45rem 0.55rem;">
        <option value="">Todos</option>
        <option value="__null__" {% if current_filters.project == '__null__' %}selected{% endif %}>‚ùå Sin proyecto</option>
        {% for proj in projects %}
          <option value="{{ proj.name }}" {% if current_filters.project == proj.name %}selected{% endif %}>{{ proj.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label style="display:block;font-weight:600;margin-bottom:0.25rem;">Beneficiario</label>
      <select name="payee" style="width:100%;padding:0.45rem 0.55rem;">
        <option value="">Todos</option>
        <option value="__null__" {% if current_filters.payee == '__null__' %}selected{% endif %}>‚ùå Sin beneficiario</option>
        {% for p in payees %}
          <option value="{{ p.name }}" {% if current_filters.payee == p.name %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label style="display:block;font-weight:600;margin-bottom:0.25rem;">Moneda</label>
      <select name="currency" style="width:100%;padding:0.45rem 0.55rem;">
        <option value="">Todas</option>
        {% for curr in currencies %}
          <option value="{{ curr }}" {% if current_filters.currency == curr %}selected{% endif %}>{{ curr }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label style="display:block;font-weight:600;margin-bottom:0.25rem;">Mes (YYYY-MM)</label>
      <input type="text" name="month" value="{{ current_filters.month }}" placeholder="2024-12" pattern="\d{4}-\d{2}" style="width:100%;padding:0.45rem 0.55rem;">
    </div>
    <div>
      <label style="display:block;font-weight:600;margin-bottom:0.25rem;">Desde</label>
      <input type="date" name="date_from" value="{{ current_filters.date_from }}" style="width:100%;padding:0.45rem 0.55rem;">
    </div>
    <div>
      <label style="display:block;font-weight:600;margin-bottom:0.25rem;">Hasta</label>
      <input type="date" name="date_to" value="{{ current_filters.date_to }}" style="width:100%;padding:0.45rem 0.55rem;">
    </div>
    <div style="display:flex;align-items:flex-end;gap:0.5rem;">
      <button type="submit">Filtrar</button>
      <a href="{% url 'expenses:manage_transactions' %}" style="padding:0.5rem 1rem;text-decoration:none;background:#6b7280;color:white;border-radius:3px;">Limpiar</a>
    </div>
    </div>
  </form>
  {% if page_obj %}
    <p style="margin-top:0.75rem;margin-bottom:0;color:var(--muted);">Total: {{ page_obj.paginator.count }} transacciones</p>
  {% endif %}
</section>

<!-- Transactions List -->
<section class="filters-section">
  <h2 style="margin-top:0">Lista de Transacciones</h2>
  {% if page_obj and page_obj.object_list %}
    <p style="margin-top:0;color:var(--muted);">Mostrando {{ page_obj.object_list|length }} de {{ page_obj.paginator.count }}.</p>
    <div class="tx-list">
      {% for tx in page_obj %}
        <form id="tx-{{ tx.id }}" action="" method="post" class="tx-card">
          {% csrf_token %}
          <input type="hidden" name="action" value="update_tx">
          <input type="hidden" name="tx_id" value="{{ tx.id }}">

          <!-- Header: 2 l√≠neas compactas -->
          <div class="tx-header">
            <div class="tx-info">
              <div class="tx-meta"><span class="tx-id">#{{ tx.id }}</span>{{ tx.date }}</div>
              <div class="tx-desc" title="{{ tx.description }}">{{ tx.description }}</div>
            </div>
            <div class="tx-amount">{{ tx.currency }} {{ tx.amount }}</div>
          </div>
          
          <!-- Save status (flotante) -->
          <div id="save-status-{{ tx.id }}" class="save-status">
            <span class="spinner htmx-indicator"></span>
            <span class="status-text"></span>
          </div>
          
          <!-- Campos: 2 columnas en desktop, 1 en mobile -->
          <div class="tx-fields">
            <div class="tx-field">
              <label>üìÅ Categor√≠a</label>
              <select name="category_id"
                      hx-post="{% url 'expenses:manage_transactions' %}"
                      hx-include="[name='tx_id'],[name='action'],[name='source_id'],[name='project_id'],[name='comments']"
                      hx-trigger="change"
                      hx-target="#save-status-{{ tx.id }}"
                      hx-swap="innerHTML"
                      hx-indicator="#save-status-{{ tx.id }}">
                <option value="">-</option>
                {% for cat in categories %}
                  <option value="{{ cat.id }}" {% if tx.category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="tx-field">
              <label>üí≥ Origen</label>
              <select name="source_id"
                      hx-post="{% url 'expenses:manage_transactions' %}"
                      hx-include="[name='tx_id'],[name='action'],[name='category_id'],[name='project_id'],[name='comments']"
                      hx-trigger="change"
                      hx-target="#save-status-{{ tx.id }}"
                      hx-swap="innerHTML"
                      hx-indicator="#save-status-{{ tx.id }}">
                <option value="">-</option>
                {% for src in sources %}
                  <option value="{{ src.id }}" {% if tx.source_id == src.id %}selected{% endif %}>{{ src.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="tx-field">
              <label>üéØ Proyecto</label>
              <select name="project_id"
                      hx-post="{% url 'expenses:manage_transactions' %}"
                      hx-include="[name='tx_id'],[name='action'],[name='category_id'],[name='source_id'],[name='comments']"
                      hx-trigger="change"
                      hx-target="#save-status-{{ tx.id }}"
                      hx-swap="innerHTML"
                      hx-indicator="#save-status-{{ tx.id }}">
                <option value="">-</option>
                {% for proj in projects %}
                  <option value="{{ proj.id }}" {% if tx.project_id == proj.id %}selected{% endif %}>{{ proj.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          
          <!-- Footer: Comentario + Delete -->
          <div class="tx-footer">
            <div class="tx-comment">
              <label>üí¨ Comentario</label>
              <textarea name="comments"
                        rows="1"
                        placeholder="A√±adir nota..."
                        hx-post="{% url 'expenses:manage_transactions' %}"
                        hx-include="[name='tx_id'],[name='action'],[name='category_id'],[name='source_id'],[name='project_id']"
                        hx-trigger="input changed delay:1s"
                        hx-target="#save-status-{{ tx.id }}"
                        hx-swap="innerHTML"
                        hx-indicator="#save-status-{{ tx.id }}">{{ tx.comments }}</textarea>
            </div>
            <button type="button"
                    class="delete-btn"
                    hx-post="{% url 'expenses:manage_transactions' %}"
                    hx-vals='{"action": "delete_tx", "tx_id": "{{ tx.id }}"}'
                    hx-confirm="¬øEliminar?"
                    hx-target="#tx-{{ tx.id }}"
                    hx-swap="outerHTML swap:300ms">üóëÔ∏è</button>
          </div>
        </form>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_previous or page_obj.has_next %}
      <div class="pagination" style="display:flex;justify-content:space-between;align-items:center;margin-top:1rem;padding-top:0.75rem;border-top:2px solid var(--border);">
        <div>
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if current_filters.search %}&search={{ current_filters.search }}{% endif %}{% if current_filters.category %}&category={{ current_filters.category }}{% endif %}{% if current_filters.source %}&source={{ current_filters.source }}{% endif %}{% if current_filters.project %}&project={{ current_filters.project }}{% endif %}{% if current_filters.payee %}&payee={{ current_filters.payee }}{% endif %}{% if current_filters.currency %}&currency={{ current_filters.currency }}{% endif %}{% if current_filters.month %}&month={{ current_filters.month }}{% endif %}{% if current_filters.date_from %}&date_from={{ current_filters.date_from }}{% endif %}{% if current_filters.date_to %}&date_to={{ current_filters.date_to }}{% endif %}">¬´ Anterior</a>
          {% endif %}
        </div>
        <div>
          P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        </div>
        <div>
          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if current_filters.search %}&search={{ current_filters.search }}{% endif %}{% if current_filters.category %}&category={{ current_filters.category }}{% endif %}{% if current_filters.source %}&source={{ current_filters.source }}{% endif %}{% if current_filters.project %}&project={{ current_filters.project }}{% endif %}{% if current_filters.payee %}&payee={{ current_filters.payee }}{% endif %}{% if current_filters.currency %}&currency={{ current_filters.currency }}{% endif %}{% if current_filters.month %}&month={{ current_filters.month }}{% endif %}{% if current_filters.date_from %}&date_from={{ current_filters.date_from }}{% endif %}{% if current_filters.date_to %}&date_to={{ current_filters.date_to }}{% endif %}">Siguiente ¬ª</a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  {% else %}
    <p style="margin:0">No se encontraron transacciones.</p>
  {% endif %}
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const toggleBtn = document.getElementById('toggle-filters');
  const toggleText = document.getElementById('toggle-text');
  const filtersGrid = document.getElementById('filters-grid');
  
  if (!toggleBtn || !toggleText || !filtersGrid) {
    console.error('Filter elements not found');
    return;
  }
  
  // Always start with filters hidden
  filtersGrid.style.setProperty('display', 'none', 'important');
  toggleText.textContent = 'Mostrar filtros';
  
  toggleBtn.addEventListener('click', function() {
    const currentDisplay = window.getComputedStyle(filtersGrid).display;
    if (currentDisplay === 'none') {
      filtersGrid.style.setProperty('display', 'grid', 'important');
      toggleText.textContent = 'Ocultar filtros';
    } else {
      filtersGrid.style.setProperty('display', 'none', 'important');
      toggleText.textContent = 'Mostrar filtros';
    }
  });
});
</script>

{% endblock %}
